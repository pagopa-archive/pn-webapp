<!doctype html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <title>PN: Pubblica Amministrazione</title>
    <meta name="description" content="PN: Pubblica Amministrazione">
    <meta name="API-GW" content="${API_GW_BASE_URL}">
    <script src="js/jquery-3.6.0.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-base64@3.7.0/base64.min.js"></script>
</head>
<body>
    <p>PN: Pubblica Amministrazione</p>
    <p>
        Fill<br>
        the api-key secret <input type="password" id="API-Key" value="" />,<br>
        the PA id <input type="text" id="paId" value="" />,<br>
        the protocol number <input type="text" id="paNotificationId" value="" />,<br>
        and the subject <input type="text" id="subject" value="" />.<br>
    </p>
    <p>
        Attach Files<br>
        <input type="checkbox" id="file-check1"><input class="doc" type="file" id="file-input1" data-idx="0" /><br>
        <input type="checkbox" id="file-check2"><input class="doc" type="file" id="file-input2" data-idx="1" /><br>
        <input type="checkbox" id="file-check3"><input class="doc" type="file" id="file-input3" data-idx="2" /><br>
        <input type="checkbox" id="file-check4"><input class="doc" type="file" id="file-input4" data-idx="3" /><br>
    </p>
    <p id="recipients">
        Select Recipients<br>
    </p>
    <p>
        Then <button id="btn">Direct load</button> <br>
        or <button id="preload">Preload File</button> and <button id="notify">Confirm notification</button> <br>
    </p>
    <div id="output">

    </div>
</body>
<script>
let RECIPIENT_DATA = {
    "CGNNMO80A01H501M" : {
        taxId: "CGNNMO80A01H501M",
        denomination: "Nome1 Cognome1",
        pecAddress: "nome1.cognome1@fail-both.domicilio-digitale.it"
    },
    "CGNNMO80A02H501R" : {
        taxId: "CGNNMO80A02H501R",
        denomination: "Nome2 Cognome2",
        pecAddress: "nome2.cognome2@fail-first.domicilio-digitale.it"
    },
    "CGNNMO80A03H501T" : {
        taxId: "CGNNMO80A03H501T",
        denomination: "Nome3 Cognome3",
        pecAddress: "nome3.cognome3@fail-first.domicilio-digitale.it"
    }
}
let DATA = {
    files: []
}

function unit8ToHexString( arrayBuffer ) {
    let dv = new DataView( arrayBuffer );

    return Array( arrayBuffer.byteLength )
        .fill()
        .map( (x, idx) => dv.getUint8(idx) )
        .map( el => { let str = el.toString(16); if(str.length == 1 ) str = '0'+str; return str} )
        .join('');
}

function logMessage( msgString ) {
    jQuery('#output').prepend( '<pre><b>' + (new Date()) + '</b> '+ msgString + '</pre>\n' )
}
function fillSelects() {
    let idx = 1;
    for( let key of Object.keys( RECIPIENT_DATA ) ) {
        let info = RECIPIENT_DATA[key];
        jQuery('#recipients')
            .append('<input type="checkbox" id="recipient-check' + (idx++) + '" data-tax-id="' + info.taxId + '">' 
                            + info.taxId + ' ' + info.denomination + ' ' + info.pecAddress + '<br>');
    }
    jQuery("select.recipient").each( ( idx, el) => {
        jEl = jQuery(el);
        
    })
}


function readSingleFile( evtTarget, idx) {
  var file = evtTarget.files[0];
  if (!file) {
    return;
  }
  var reader = new FileReader();
  reader.onload = function(e) {
    var contents = e.target.result;
    var parts = contents.split(";base64,");
    
    var fileBody = parts[1];
    var contentType = parts[0].substring( "data:".length, parts[0].length )
    DATA.files[ idx ] = {
        body: fileBody,
        contentType: contentType
    }
    
    //console.log( { "body": fileBody, "contentType": contentType } );
    logMessage("File selected")
  };
  reader.readAsDataURL(file);
}




async function sendNotification() {
    let url = jQuery('meta[name="API-GW"]').attr('content') + '/delivery/notifications/sent'
    let apiKey = jQuery('#API-Key').val()
    let paId = jQuery('#paId').val()
    let paNotificationId = jQuery('#paNotificationId').val()
    let subject = jQuery('#subject').val()

    let requestBody = {
            paNotificationId: paNotificationId,
            subject: subject,
            cancelledIun: null,
            recipients: [],
            documents: []
        };
    for( let i = 1; i <= 4; i++ ) {
        if( jQuery('#file-check'+i).is(':checked') ) {
            let f = DATA.files[i-1];
            let sha256 = await crypto.subtle.digest('SHA-256', Base64.toUint8Array( f.body ));
            requestBody.documents.push({
                body: f.body,
                contentType: f.contentType,
                digests : {
                    sha256:  unit8ToHexString( sha256 )
                }
            });
        }
    }
    for( let i = 1; i <= 3; i++ ) {
        jqEl = jQuery('#recipient-check'+i);
        if( jqEl.is(':checked') ) {
            let taxId = jqEl.data().taxId;
            let recipientInfo = RECIPIENT_DATA[taxId];
            requestBody.recipients.push({
                taxId: taxId,
                denomination: recipientInfo.denomination,
                digitalDomicile: {
                    type: "PEC",
                    address: recipientInfo.pecAddress
                },
                physicalAddress: {
                    at: "string",
                    address: "string",
                    addressDetails: "string",
                    zip: "string",
                    municipality: "string",
                    province: "string"
                }
            })
        }
    }

    console.log( "Request body", requestBody );

    let request = {
        method: 'POST',
        cache: 'no-cache',
        headers: {
            'x-api-key': apiKey,
            'X-PagoPA-PN-PA': paId,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify( requestBody )
    }
    console.log( "Send request", request);
    let response = await fetch( url, request);

    let json = await response.json();
    return json;
}


jQuery(() => {
    fillSelects();
    jQuery("input.doc").each( (idx, el) => {
        el.addEventListener('change', (e) => readSingleFile(e.target, idx), false);
        readSingleFile( el, idx );
    });

    jQuery('#btn').click( (evt) => {
        sendNotification().then( msg => {
            logMessage( JSON.stringify(msg) );
        })
    });
})
</script>
<script>
async function preloadFiles() {
    let apiKey = jQuery('#API-Key').val()
    let paId = jQuery('#paId').val()

    for( let i = 1; i <= 4; i++ ) {
        if( jQuery('#file-check'+i).is(':checked') ) {
            let f = DATA.files[i-1];
            console.log("Preload " + i + ": ", f)
            let key = 'doc_' + i

            let reserveUrl = jQuery('meta[name="API-GW"]').attr('content') + '/delivery/attachments/preload';
            let preloadInfoResponse = await fetch( reserveUrl, {
                method: 'POST',
                cache: 'no-cache',
                headers: {
                    'x-api-key': apiKey,
                    'X-PagoPA-PN-PA': paId,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify( { key: key, contentType: f.contentType})
            });
            let preloadInfo = await preloadInfoResponse.json();
            console.log( preloadInfo );

            let loadUrl = preloadInfo.url
            let loadResponse = await fetch( loadUrl, {
                method: preloadInfo.httpMethod,
                cache: 'no-cache',
                headers: {
                    'Content-Type': f.contentType,
                    'x-amz-meta-secret': preloadInfo.secret
                },
                body: Base64.toUint8Array( f.body )
            });

            let versionId = loadResponse.headers.get('x-amz-version-id');
            let sha256 = await crypto.subtle.digest('SHA-256', Base64.toUint8Array( f.body ));
            console.log("Key:", preloadInfo.key, "VersionId:", versionId, "Sha256:", sha256);

            f.key = preloadInfo.key;
            f.versionId = versionId;
            f.sha256 = unit8ToHexString( sha256 );
            console.log("Updated file info ", f);

            logMessage( "Preloaded file " + f.key + " with sha256 " + f.sha256 + " and version " + f.versionId );
        }
    }
}

async function confirmNotification() {
    let url = jQuery('meta[name="API-GW"]').attr('content') + '/delivery/notifications/sent'
    let apiKey = jQuery('#API-Key').val()
    let paId = jQuery('#paId').val()
    let paNotificationId = jQuery('#paNotificationId').val()
    let subject = jQuery('#subject').val()

    let requestBody = {
            paNotificationId: paNotificationId,
            subject: subject,
            cancelledIun: null,
            recipients: [],
            documents: []
        };
    for( let i = 1; i <= 4; i++ ) {
        if( jQuery('#file-check'+i).is(':checked') ) {
            let f = DATA.files[i-1];
            let sha256 = await crypto.subtle.digest('SHA-256', Base64.toUint8Array( f.body ));
            requestBody.documents.push({
                ref : {
                    key: f.key,
                    versionToken: f.versionId
                },
                contentType: null, // f.contentType,
                digests : {
                    sha256:  f.sha256
                }
            });
        }
    }
    for( let i = 1; i <= 3; i++ ) {
        jqEl = jQuery('#recipient-check'+i);
        if( jqEl.is(':checked') ) {
            let taxId = jqEl.data().taxId;
            let recipientInfo = RECIPIENT_DATA[taxId];
            requestBody.recipients.push({
                taxId: taxId,
                denomination: recipientInfo.denomination,
                digitalDomicile: {
                    type: "PEC",
                    address: recipientInfo.pecAddress
                },
                physicalAddress: {
                    at: "Presso qualcuno",
                    address: "In via del tutto eccezionale",
                    addressDetails: "scala A",
                    zip: "CAP di " + i,
                    municipality: "Comune",
                    province: "PROV"
                }
            })
        }
    }

    console.log( "Request body", requestBody );

    let request = {
        method: 'POST',
        cache: 'no-cache',
        headers: {
            'x-api-key': apiKey,
            'X-PagoPA-PN-PA': paId,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify( requestBody )
    }
    console.log( "Send request", request);
    let response = await fetch( url, request);

    let json = await response.json();
    return json;
}

jQuery(() => {
    jQuery("#preload").click( (evt) => {
        preloadFiles();
    })
    jQuery("#notify").click( (evt) => {
        confirmNotification().then( msg => {
            logMessage( JSON.stringify(msg) );
        })
    })
})
</script>
</html>
