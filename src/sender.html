<!doctype html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <title>Mittente: Nuova Notifica</title>
    <meta name="description" content="PN: Pubblica Amministrazione">
    <meta name="API-GW" content="${API_GW_BASE_URL}">
    <script src="js/jquery-3.6.0.slim.min.js"></script>
    <script src="js/base64.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>

    <link href="js/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<style>
.row {
    margin: 10pt;
}
.toast {
    left: 50%;
    right: 50%;
    position: fixed;
    z-index: 9999;
    margin-top: 250pt;
    background-color: white;
    width: 600px;
    transform: translate(-50%, 0px);
}
.row_input {
    margin: 10pt;
    border: 1pt solid black;
}
</style>

<div class='toast' role='alert' aria-live='assertive' aria-atomic='true'>
    <div class='d-flex'>
        <div class='toast-body'></div>
        <button type='button' class='btn-close me-2 m-auto'data-bs-dismiss='toast' aria-label='Close' id="closeToast"></button>
    </div>
</div>

<div class="container">

    <h1>Mittente: Nuova Notifica</h1>

    <form class="row">
        <div class="col-sm-1">
          <label for="API-Key" class="col-form-label">API-KEY</label>
        </div>
        <div class="col-md-3">
          <input type="password" class="form-control" id="API-Key">
        </div>
        <div class="col-auto">
          <label for="API-Key" class="form-text">API Key di AWS</label>
        </div>
    </form>

    <form class="row">
        <div class="col-sm-1">
          <label for="paId" class="col-form-label">ID PA</label>
        </div>
        <div class="col-md-3">
          <input type="text" class="form-control" id="paId">
        </div>
        <div class="col-auto">
          <label for="paId" class="form-text">Identificativo della PA</label>
        </div>
    </form>

    <form class="row">
        <div class="col-sm-1">
          <label for="paNotificationId" class="col-form-label">Protocollo</label>
        </div>
        <div class="col-md-3">
          <input type="text" class="form-control" id="paNotificationId">
        </div>
        <div class="col-auto">
          <label for="paNotificationId" class="form-text">Numero di protocollo</label>
        </div>
    </form>

    <form class="row">
        <div class="col-sm-1">
          <label for="subject" class="col-form-label">Descrizione</label>
      </div>
      <div class="col-md-3">
          <input type="text" class="form-control" id="subject">
      </div>
      <div class="col-auto">
          <label for="subject" class="form-text">Descrizione notifica</label>
      </div>
    </form>

    <h3>Allega Files</h3>
    <form class="row">
        <div class="col-auto align-self-center">
            <input class="form-check-input" type="checkbox" value="" id="file-check1">
        </div>
        <div class="col-auto">
            <input class="doc form-control" type="file" id="file-input1" data-idx="0"/>
        </div>
        <div class="col-auto">

        </div>
    </form>
    <form class="row">
        <div class="col-auto align-self-center">
            <input class="form-check-input" type="checkbox" value="" id="file-check2"/>
        </div>
        <div class="col-auto">
            <input class="doc form-control" type="file" id="file-input2" data-idx="1"/>
        </div>
    </form>
    <form class="row">
        <div class="col-auto align-self-center">
            <input class="form-check-input" type="checkbox" value="" id="file-check3"/>
        </div>
        <div class="col-auto">
            <input class="doc form-control" type="file" id="file-input3" data-idx="2"/>
        </div>
    </form>
    <form class="row">
        <div class="col-auto align-self-center">
            <input class="form-check-input" type="checkbox" value="" id="file-check4"/>
        </div>
        <div class="col-auto">
            <input class="doc form-control" type="file" id="file-input4" data-idx="3"/>
        </div>
    </form>

    <h3>Seleziona Destinatari</h3>
    <div id="recipients"> </div>

    <form class="row">
        <div class="col-auto">
          <button type="button" class="btn btn-outline-dark" name="btn" id="btn">Invia Notifica e Allegati</button>
        </div>
    </form>
    <form class="row">
        <div class="col-auto">
            <button type="button" class="btn btn-outline-dark" name="btn" id="preload">Precarica Allegati</button>
        </div>
        <div class="col-auto">
            <button type="button" class="btn btn-outline-dark" name="btn" id="notify">Invia Notifica</button>
        </div>
    </form>
    <h3>Risposta</h3>
    <div id="result"></div>
</div>
</body>
<script>
    jQuery(document).ready(function(){
        let apiKey = localStorage.getItem("apiKey");
        if(apiKey) {
            jQuery('#API-Key').val(apiKey);
        }
        jQuery('#API-Key').change( (evt) => {
            let apiKey = jQuery('#API-Key').val();
            localStorage.setItem("apiKey", apiKey);
        });
    });

    let RECIPIENT_DATA = {
        "CGNNMO80A01H501M" : {
            taxId: "CGNNMO80A01H501M",
            denomination: "Nome1 Cognome1",
            pecAddress: "nome1.cognome1@fail-both.domicilio-digitale.it",
            physicalAddress: {
                    at: "Presso qualcuno",
                    address: "In via del tutto eccezionale: ImmediateResponse",
                    addressDetails: "scala A",
                    zip: "00100",
                    municipality: "Comune",
                    province: "PROV",
                    state: "IT"
                }
        },
        "CGNNMO80A02H501R" : {
            taxId: "CGNNMO80A02H501R",
            denomination: "Nome2 Cognome2",
            pecAddress: "nome2.cognome2@fail-first.domicilio-digitale.it",
            physicalAddress: {
                    at: "Presso qualcuno",
                    address: "In via del tutto eccezionale: ImmediateResponse",
                    addressDetails: "scala A",
                    zip: "00100",
                    municipality: "Comune",
                    province: "PROV",
                    state: "IT"
                }
        },
        "CGNNMO80A03H501T" : {
            taxId: "CGNNMO80A03H501T",
            denomination: "Nome3 Cognome3",
            pecAddress: "nome3.cognome3@fail-both.domicilio-digitale.it",
            physicalAddress: {
                    at: "Presso qualcuno",
                    address: "In via del tutto eccezionale: ImmediateResponse",
                    addressDetails: "scala A",
                    zip: "00100",
                    municipality: "Comune",
                    province: "PROV",
                    state: "IT"
                }
        },
        "PCTPGP00A04H501X" : {
            taxId:"PCTPGP00A04H501X",
            denomination: "PagoPA PecTest",
            pecAddress: "##",
            physicalAddress: {
                    at: "Presso qualcuno",
                    address: "In via del tutto eccezionale: ImmediateResponse",
                    addressDetails: "scala A",
                    zip: "00100",
                    municipality: "Comune",
                    province: "PROV",
                    state: "IT"
                }
        }
    }
    let DATA = {
        files: []
    }

    function unit8ToHexString( arrayBuffer ) {
        let dv = new DataView( arrayBuffer );

        return Array( arrayBuffer.byteLength )
        .fill()
        .map( (x, idx) => dv.getUint8(idx) )
        .map( el => { let str = el.toString(16); if(str.length == 1 ) str = '0'+str; return str} )
        .join('');
    }

    function logMessage( msgString ) {
        jQuery('.toast-body').append( msgString + '<br>');
        jQuery('.toast').toast('show');
    }

    function fillSelects() {
        let idx = 1;
        for( let key of Object.keys( RECIPIENT_DATA ) ) {
            let info = RECIPIENT_DATA[key];
            let content = "<form class='row'>"
                        + "<div class='col-auto align-self-center'>"
                        + "<input class='form-check-input' type='checkbox' value='' id='recipient-check" + (idx++) +"' data-tax-id='" +info.taxId + "'>"
                        + "</div> <div class='col-auto'>";
            if( "##" == info.pecAddress ) {
                //content += "<div class='col-auto'>";
                content += "<label class='col-form-label'> "+ info.taxId + " " + info.denomination + " <input class='' id='pecAddrReal' value=''></label>";
                content += "</div> <div class='col-xl-6'>"
                content += "<div class='row'> <div class='col-md-2'> Presso: </div> <input class='col-auto' id='atReal' value=''></div>";
                content += "<div class='row'> <div class='col-md-2'> Via: </div> <input class='col-auto' id='addressReal' value=''></div>";
                content += "<div class='row'> <div class='col-md-2'> Scala: </div><input class='col-auto' id='addressDetailsReal' value=''></div>";
                content += "<div class='row'> <div class='col-md-2'> Zip: </div><input class='col-auto' id='zipReal' value=''></div>";
                content += "<div class='row'> <div class='col-md-2'> Comune: </div><input class='col-auto' id='municipalityReal' value=''></div>";
                content += "<div class='row'> <div class='col-md-2'> Provincia: </div><input class='col-auto' id='provinceReal' value=''></div>";
                content += "<div class='row'> <div class='col-md-2'> Stato: </div><input class='col-auto' id='stateReal' value=''></div>";
                
            }
            else {
                content += "<label class='col-form-label'> "+ info.taxId + " " + info.denomination + " " + info.pecAddress +"</label> </form>";
            }
            //content += "</div></form>";
            jQuery('#recipients')
            .append(content);
        }
        jQuery("select.recipient").each( ( idx, el) => {
            jEl = jQuery(el);

        })
    }

    function readSingleFile( evtTarget, idx) {
      var file = evtTarget.files[0];
      if (!file) {
        return;
    }
    var reader = new FileReader();
    reader.onload = function(e) {
        var contents = e.target.result;
        var parts = contents.split(";base64,");

        var fileBody = parts[1];
        var contentType = parts[0].substring( "data:".length, parts[0].length )
        DATA.files[ idx ] = {
            body: fileBody,
            contentType: contentType
        }
        logMessage("File " + file.name + " caricato correttamente.");
    };
    reader.readAsDataURL(file);
}

function printResponse(json) {

    jQuery('#result').prepend("<form class='row'> <div class='col-auto'><h5>Data: </h5>" +(new Date())+ "</div> <div class='col-auto'><h5>IUN: </h5>" + json.iun + "</div><div class='col-auto'><h5>Protocollo: </h5>" + json.paNotificationId + "</div></form>");
}

async function sendNotification() {
    let url = jQuery('meta[name="API-GW"]').attr('content') + '/delivery/notifications/sent'
    let apiKey = jQuery('#API-Key').val()
    let paId = jQuery('#paId').val()
    let paNotificationId = jQuery('#paNotificationId').val()
    let subject = jQuery('#subject').val()

    let requestBody = {
        paNotificationId: paNotificationId,
        subject: subject,
        cancelledIun: null,
        recipients: [],
        documents: []
    };
    for( let i = 1; i <= 4; i++ ) {
        if( jQuery('#file-check'+i).is(':checked') ) {
            let f = DATA.files[i-1];
            let sha256 = await crypto.subtle.digest('SHA-256', Base64.toUint8Array( f.body ));
            requestBody.documents.push({
                body: f.body,
                contentType: f.contentType,
                digests : {
                    sha256:  unit8ToHexString( sha256 )
                }
            });
        }
    }
    for( let i = 1; i <= 4; i++ ) {
        jqEl = jQuery('#recipient-check'+i);
        if( jqEl.is(':checked') ) {
            let taxId = jqEl.data().taxId;
            let recipientInfo = RECIPIENT_DATA[taxId];
            let realPecAddr = recipientInfo.pecAddress;
            let at = recipientInfo.physicalAddress.at;
            let address = recipientInfo.physicalAddress.address;
            let addressDetails = recipientInfo.physicalAddress.addressDetails;
            let zip = recipientInfo.physicalAddress.zip;
            let municipality = recipientInfo.physicalAddress.municipality;
            let province = ecipientInfo.physicalAddress.province;
            let state = ecipientInfo.physicalAddress.state;
            if( "##" == realPecAddr ) {
                realPecAddr = jQuery('#pecAddrReal').val();
                at = jQuery('#atReal').val();
                address = jQuery('#addressReal').val();
                addressDetails = jQuery('#addressDetailsReal').val();
                zip = jQuery('#zipReal').val();
                municipality = jQuery('#municipalityReal').val();
                province = jQuery('#provinceReal').val();
                state = jQuery('#stateReal').val();
            }
            requestBody.recipients.push({
                taxId: taxId,
                denomination: recipientInfo.denomination,
                digitalDomicile: {
                    type: "PEC",
                    address: realPecAddr
                },
                physicalAddress: {
                    at: at,
                    address: address,
                    addressDetails: addressDetails,
                    zip: zip,
                    municipality: municipality,
                    province: province,
                    state: state
                }
            })
        }
    }

    let request = {
        method: 'POST',
        cache: 'no-cache',
        headers: {
            'x-api-key': apiKey,
            'X-PagoPA-PN-PA': paId,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify( requestBody )
    }

    let response = await fetch( url, request);

    let json = await response.json();
    return json;
}


jQuery(() => {
    fillSelects();
    jQuery("input.doc").each( (idx, el) => {
        el.addEventListener('change', (e) => readSingleFile(e.target, idx), false);
        readSingleFile( el, idx );
    });

    jQuery('#btn').click( (evt) => {
        sendNotification().then( msg => {
            printResponse(msg);
        })
    });

    jQuery('#closeToast').click( (evt) => {
       jQuery('.toast-body').empty();
    });
})
</script>
<script>
async function preloadFiles() {
    let apiKey = jQuery('#API-Key').val()
    let paId = jQuery('#paId').val()

    for( let i = 1; i <= 4; i++ ) {
        if( jQuery('#file-check'+i).is(':checked') ) {
            let f = DATA.files[i-1];
            console.log("Preload " + i + ": ", f)
            let key = 'doc_' + i

            let reserveUrl = jQuery('meta[name="API-GW"]').attr('content') + '/delivery/attachments/preload';
            let preloadInfoResponse = await fetch( reserveUrl, {
                method: 'POST',
                cache: 'no-cache',
                headers: {
                    'x-api-key': apiKey,
                    'X-PagoPA-PN-PA': paId,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify( { key: key, contentType: f.contentType})
            });
            let preloadInfo = await preloadInfoResponse.json();
            console.log( preloadInfo );

            let loadUrl = preloadInfo.url
            let loadResponse = await fetch( loadUrl, {
                method: preloadInfo.httpMethod,
                cache: 'no-cache',
                headers: {
                    'Content-Type': f.contentType,
                    'x-amz-meta-secret': preloadInfo.secret
                },
                body: Base64.toUint8Array( f.body )
            });

            let versionId = loadResponse.headers.get('x-amz-version-id');
            let sha256 = await crypto.subtle.digest('SHA-256', Base64.toUint8Array( f.body ));
            console.log("Key:", preloadInfo.key, "VersionId:", versionId, "Sha256:", sha256);

            f.key = preloadInfo.key;
            f.versionId = versionId;
            f.sha256 = unit8ToHexString( sha256 );
            console.log("Updated file info ", f);

            logMessage( "Caricato file: " + f.key + " con sha256: " + f.sha256 + " e versione: " + f.versionId );
        }
    }
}

async function confirmNotification() {
    let url = jQuery('meta[name="API-GW"]').attr('content') + '/delivery/notifications/sent'
    let apiKey = jQuery('#API-Key').val()
    let paId = jQuery('#paId').val()
    let paNotificationId = jQuery('#paNotificationId').val()
    let subject = jQuery('#subject').val()

    let requestBody = {
            paNotificationId: paNotificationId,
            subject: subject,
            cancelledIun: null,
            recipients: [],
            documents: []
        };
    for( let i = 1; i <= 4; i++ ) {
        if( jQuery('#file-check'+i).is(':checked') ) {
            let f = DATA.files[i-1];
            let sha256 = await crypto.subtle.digest('SHA-256', Base64.toUint8Array( f.body ));
            requestBody.documents.push({
                ref : {
                    key: f.key,
                    versionToken: f.versionId
                },
                contentType: null, // f.contentType,
                digests : {
                    sha256:  f.sha256
                }
            });
        }
    }
    for( let i = 1; i <= 4; i++ ) {
        jqEl = jQuery('#recipient-check'+i);
        if( jqEl.is(':checked') ) {
            let taxId = jqEl.data().taxId;
            let recipientInfo = RECIPIENT_DATA[taxId];
            let realPecAddr = recipientInfo.pecAddress;
            if( "##" == realPecAddr ) {
                realPecAddr = jQuery('#pecAddrReal').val();
            }
            requestBody.recipients.push({
                taxId: taxId,
                denomination: recipientInfo.denomination,
                digitalDomicile: {
                    type: "PEC",
                    address: realPecAddr
                },
                physicalAddress: {
                    at: recipientInfo.physicalAddress.at,
                    address: recipientInfo.physicalAddress.address,
                    addressDetails: recipientInfo.physicalAddress.addressDetails,
                    zip: recipientInfo.physicalAddress.zip,
                    municipality: recipientInfo.physicalAddress.municipality,
                    province: ecipientInfo.physicalAddress.province,
                    state: ecipientInfo.physicalAddress.state
                }
            })
        }
    }

    console.log( "Request body", requestBody );

    let request = {
        method: 'POST',
        cache: 'no-cache',
        headers: {
            'x-api-key': apiKey,
            'X-PagoPA-PN-PA': paId,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify( requestBody )
    }
    console.log( "Send request", request);
    let response = await fetch( url, request);

    let json = await response.json();
    return json;
}

jQuery(() => {
    jQuery("#preload").click( (evt) => {
        preloadFiles();
    })
    jQuery("#notify").click( (evt) => {
        confirmNotification().then( msg => {
            printResponse( msg );
        })
    })
})
</script>
</html>
