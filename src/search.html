<!doctype html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <title>PN: Search</title>
    <meta name="description" content="PN: Search">
    <meta name="API-GW" content="${API_GW_BASE_URL}">
    <script src="js/jquery-3.6.0.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-base64@3.7.0/base64.min.js"></script>
</head>
<body>
    <style>
        .notificationTable{
            width: 100%;
            border: 1px solid black;
            border-collapse: collapse;
        }
        .row{ 
            text-align: center;
            border: 1px solid black;
        }
        .header{
            border: 1px solid black;
        }
        .element{
            border: 1px solid black;
        }
        
    </style>
    <div>PN: Ricerca Notifiche</div>
    <div>
        <form name="search">
            <table border="0">
                <tr>
                    <td>USER ID: </td>
                    <td><input type="text" name="txtUserId" id="txtUserId"></td>
                </tr>
                <tr>
                    <td>Sender ID: </td>
                    <td><input type="text" name="txtSenderId" id="txtSenderId"></td>
                </tr>
                <tr>
                    <td>Start Date: </td>
                    <td><input type="datetime" name="dtStartDate" id="dtStartDate"></td>
                </tr>
                <tr>
                    <td>End Date: </td>
                    <td><input type="datetime" name="dtEndDate" id="dtEndDate"></td>
                </tr>
                <tr>
                    <td>Recipient ID: </td>
                    <td><input type="text" name="txtRecipientId" id="txtRecipientId"></td>
                </tr>
                <tr>
                    <td>Status: </td>
                    <td><select type="text" name="txtStatus" id="txtStatus"> 
                        <option selected="selected"></option>
                        <option>RECEIVED_ACK</option>
                        <option>NOTIFICATION_PATH_CHOOSE</option>
                        <option>SEND_DIGITAL_DOMICILE</option>
                        <option>SEND_DIGITAL_DOMICILE_FEEDBACK</option>
                        <option>WAIT_FOR_RECIPIENT_TIMEOUT</option>
                        <option>VIEWED</option>
                        <option>PAYMENT</option>
                     </select> </td>
                </tr>
                <tr>
                    <td>Subject: </td>
                    <td><input type="text" name="txtSubject" id="txtSubject"></td>
                </tr>
                <tr>
                    <td colspan="2">&nbsp;</td>
                </tr>
                <tr>
                    <td colspan="2" align="left"><input type="button" name="btnSearch" id="btnSearch" value="Ricerca"></td>
                </tr>
            </table>
        </form>
    </div>
    
    <script type="text/javascript">
        jQuery(document).ready(function(){
            jQuery('#btnSearch').click(function(){
                let endPoint = jQuery('meta[name="API-GW"]').attr('content') + '/delivery/notifications/sent?';
                let senderId = jQuery('#txtSenderId').val();
                let startDate = jQuery('#dtStartDate').val();
                let endDate = jQuery('#dtEndDate').val();
                let recipientId = jQuery('#txtRecipientId').val();
                let status = jQuery('#txtStatus').val();
                let subjectRegExp = jQuery('#txtSubject').val();

                if(!senderId || !startDate || !endDate) {
                    alert('Please specify Sender ID, Start Date and End Date field');
                    return;
                }
                
                
                let url = addQueryParams(endPoint, senderId, startDate, endDate, recipientId, status, subjectRegExp);
                console.log(url);
                fetchNotification(url, senderId);
            });
        });
        
        async function fetchNotification(url, userId) {
            let apiKey = jQuery('#API-Key').val()
            let request = {
                method: 'GET',
                cache: 'no-cache',
                headers: {
                    'X-PagoPA-PN-PA': userId,
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey
                }
            }
            
            let response = await fetch(url, request);
            
            if (!response.ok) {
                alert('An error has occured: ${response.status}');
                return;
            }
            
            let json = await response.json();
            printNotification(json);
        }
        
        function addQueryParams(endPoint, senderId, startDate, endDate, recipientId, status, subjectRegExp) {
            var url = new URL(endPoint);
            url.searchParams.append('senderId', senderId);
            url.searchParams.append('startDate', startDate);
            url.searchParams.append('endDate', endDate);
            if(recipientId) url.searchParams.append('recipientId', recipientId);
            if(status) url.searchParams.append('status', status);
            if(subjectRegExp) url.searchParams.append('subjectRegExp', subjectRegExp);
            return url;
        }
        
        function printNotification(json) {
            console.log(json);
            jQuery('#container').text("");

            jQuery('#container').append("<b>Notification</b>");
            //jQuery('#container').append("<pre>" + JSON.stringify( json, null, 2)+ "</pre>");

            var content = "<table class='notificationTable'> <tr class='row'> <th class='header'>IUN</th> <th class='header'>STATUS</th> <th class='header'>SENDERID</th> <th class='header'>SENTAT</th> <th class='header'>PANOTIFICATIONID</th> <th class='header'>RECIPIENTID</th> <th class='header'>SUBJECT</th> </tr>"
                json.forEach(element => {
                    content += "<tr class='row'> <td class='element'>" + element.iun + "</td><td class='element'>" +
                         element.notificationStatus + "</td><td class='element'>" + element.senderId +
                             "</td><td class='element'>" + element.sentAt + "</td><td class='element'>" +
                                  element.paNotificationId + "</td><td class='element'>" + element.recipientId +
                                     "</td><td class='element'>" + element.subject  + "</td> </tr>";
            });
            content += "</table>"
            jQuery('#container').append(content); 
        }
    </script>

    <br/><br/>
    <div id="container">
    </div>
</body>
</html>