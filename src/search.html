<!doctype html>
    <html lang="it">
    <head>
        <meta charset="utf-8">
        <title>PN: Search</title>
        <meta name="description" content="PN: Search">
        <meta name="API-GW" content="${API_GW_BASE_URL}">
        <script src="js/jquery-3.6.0.slim.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/js-base64@3.7.0/base64.min.js"></script>
    </head>
    <body>
        <style>
        .notificationTable{
            width: 100%;
            border: 1px solid black;
            border-collapse: collapse;
        }
        .row{ 
            text-align: center;
            border: 1px solid black;
        }
        .header{
            border: 1px solid black;
        }
        .element{
            border: 1px solid black;
        }
        .inputForm {
            width: 100%;
        }
        .inputText{
            margin-top: 10pt;
            width: 30%;
            display: block;
        }
        .lableText {
            margin-top: 10pt;
            display: block;
        }
        
    </style>
    <div>PN: Ricerca Notifiche</div>
    <div class="inputForm">
        <form name="search">

            <label class="labelText" for="API-Key"><b>API-KEY: </b></label>
            <input class="inputText" type="password" name="API-Key" id="API-Key" required>

            <label class="labelText" for="txtUserId"><b>USER ID: </b></label>
            <input class="inputText" type="text" name="txtUserId" id="txtUserId">

            <label class="labelText" for="txtSenderId"><b>Sender ID: </b></label>
            <input class="inputText" type="text" name="txtSenderId" id="txtSenderId" required>

            <label class="labelText" for="dtStartDate"><b>Start Date: </b></label>
            <input class="inputText" type="datetime" name="dtStartDate" id="dtStartDate" placeholder="YYYY-MM-DDThh:mm:ss.SSSZ" required>

            <label class="labelText" for="dtEndDate"><b>End Date: </b></label>
            <input class="inputText" type="datetime" name="dtEndDate" id="dtEndDate" placeholder="YYYY-MM-DDThh:mm:ss.SSSZ" required>

            <label class="labelText" for="txtRecipientId"><b>Recipient ID: </b></label>
            <input class="inputText" type="text" name="txtRecipientId" id="txtRecipientId">

            <label class="labelText" for="txtStatus"><b>Status: </b></label>
            <select class="inputText" type="text" name="txtStatus" id="txtStatus"> 
                <option selected="selected"></option>
                <option>RECEIVED</option>
                <option>DELIVERING</option>
                <option>DELIVERED</option>
                <option>VIEWED</option>
                <option>EFFECTIVE_DATE</option>
                <option>PAID</option>
            </select>

            <label for="txtSubject"><b>Subject: </b></label>
            <input class="inputText" type="text" name="txtSubject" id="txtSubject" placeholder=".*{textToSearch}.*">

            <button type="submit" name="btnSearch" id="btnSearch">Ricerca</button>
        </form>
    </div>
    
    <script type="text/javascript">
        jQuery(document).ready(function(){
            jQuery('#btnSearch').click(function(){
                let endPoint = jQuery('meta[name="API-GW"]').attr('content') + '/delivery/notifications/sent?';
                let senderId = jQuery('#txtSenderId').val();
                let startDate = jQuery('#dtStartDate').val();
                let endDate = jQuery('#dtEndDate').val();
                let recipientId = jQuery('#txtRecipientId').val();
                let status = jQuery('#txtStatus').val();
                let subjectRegExp = jQuery('#txtSubject').val();

                if(!senderId || !startDate || !endDate) {
                    alert('Please specify Sender ID, Start Date and End Date field');
                    return;
                }
                
                
                let url = addQueryParams(endPoint, senderId, startDate, endDate, recipientId, status, subjectRegExp);
                console.log(url);
                fetchNotification(url, senderId);
            });
        });
        
        async function fetchNotification(url, userId) {
            let apiKey = jQuery('#API-Key').val()
            let request = {
                method: 'GET',
                cache: 'no-cache',
                headers: {
                    'X-PagoPA-PN-PA': userId,
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey
                }
            }
            
            let response = await fetch(url, request);
            
            if (!response.ok) {
                alert('An error has occured: ${response.status}');
                return;
            }
            
            let json = await response.json();
            printNotification(json);
        }
        
        function addQueryParams(endPoint, senderId, startDate, endDate, recipientId, status, subjectRegExp) {
            var url = new URL(endPoint);
            url.searchParams.append('senderId', senderId);
            url.searchParams.append('startDate', startDate);
            url.searchParams.append('endDate', endDate);
            if(recipientId) url.searchParams.append('recipientId', recipientId);
            if(status) url.searchParams.append('status', status);
            if(subjectRegExp) url.searchParams.append('subjectRegExp', subjectRegExp);
            return url;
        }
        
        function printNotification(json) {
            console.log(json);
            jQuery('#container').text("");

            jQuery('#container').append("<b>Notification</b>");

            var content = "<table class='notificationTable'> <tr class='row'> <th class='header'>IUN</th> <th class='header'>STATUS</th> <th class='header'>SENDERID</th> <th class='header'>SENTAT</th> <th class='header'>PANOTIFICATIONID</th> <th class='header'>RECIPIENTID</th> <th class='header'>SUBJECT</th> </tr>"
            json.forEach(element => {
                content += "<tr class='row'> <td class='element'>" + element.iun + "</td><td class='element'>" +
                element.notificationStatus + "</td><td class='element'>" + element.senderId +
                "</td><td class='element'>" + element.sentAt + "</td><td class='element'>" +
                element.paNotificationId + "</td><td class='element'>" + element.recipientId +
                "</td><td class='element'>" + element.subject  + "</td> </tr>";
            });
            content += "</table>"
            jQuery('#container').append(content); 
        }
    </script>

    <br/><br/>
    <div id="container">
    </div>
</body>
</html>