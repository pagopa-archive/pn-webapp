<!doctype html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <title>Hello, CDN!</title>
    <meta name="description" content="Hello CDN">
    <meta name="API-GW" content="${API_GW_BASE_URL}">
    <script src="js/jquery-3.6.0.slim.min.js"
		integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI="
		crossorigin="anonymous">
    </script>
</head>
<body>
    <p>Hello CDN</p>
    <p>
        Fill<br>
        the api-key secret <input type="password" id="API-Key" value="" />,<br>
        the PA id <input type="text" id="paId" value="" /><br>
        and the protocol number <input type="text" id="paNotificationId" value="" />.<br>
        Attach a file <input type="file" id="file-input" /><br>
    </p>
    <p>
        Then
        <button id="btn">Call API-GW</button>
    </p>
    <div id="output">

    </div>
</body>
<script>
function logMessage( msgString ) {
    jQuery('#output').prepend( '<pre><b>' + (new Date()) + '</b> '+ msgString + '</pre>\n' )
}

var fileBody = "";
var contentType = "";

document.getElementById('file-input').addEventListener('change', readSingleFile, false);
function readSingleFile(e) {
  var file = e.target.files[0];
  if (!file) {
    return;
  }
  var reader = new FileReader();
  reader.onload = function(e) {
    var contents = e.target.result;
    displayContents(contents);
  };
  reader.readAsDataURL(file);
}
function displayContents(contents) {
  var parts = contents.split(";base64,");
  fileBody = parts[1];
  contentType = parts[0].substring( "data:".length, parts[0].length )
  console.log( { "body": fileBody, "contentType": contentType } );

  logMessage("File selected")
}




async function getHello() {
    let url = jQuery('meta[name="API-GW"]').attr('content') + '/delivery/notifications/sent'
    let apiKey = jQuery('#API-Key').val()
    let paId = jQuery('#paId').val()
    let paNotificationId = jQuery('#paNotificationId').val()

    let response = await fetch( url, {
        method: 'POST',
        cache: 'no-cache',
        headers: {
            'x-api-key': apiKey,
            'X-PagoPA-PN-PA': paId,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            paNotificationId: paNotificationId,
            subject: "Hello World",
            cancelledIun: null,
            recipients: [{
                taxId: "CodiceFiscale",
                denomination: "Name1 Surname1",
                digitalDomicile: {
                    type: "PEC",
                    address: "hello@world.it"
                },
                physicalAddress: {
                    at: "string",
                    address: "string",
                    addressDetails: "string",
                    zip: "string",
                    municipality: "string",
                    province: "string"
                }
            }],
            documents: [{
                digests: {
                    sha256: "string"
                },
                contentType: contentType,
                body: fileBody
            }]
        })
    });

    let json = await response.json();
    return json;
}


jQuery(() => {
    jQuery('#btn').click( (evt) => {
        getHello().then( msg => {
            logMessage( JSON.stringify(msg) );
        })
    });
})
</script>
</html>
